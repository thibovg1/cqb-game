<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CQB Ops: Breach & Clear 3D</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', sans-serif;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            border: 2px solid rgba(0, 255, 0, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        #ui {
            position: absolute;
            bottom: 30px;
            left: 30px;
            color: white;
            text-shadow: 2px 2px 5px #000;
        }

        #health-bar {
            width: 200px;
            height: 8px;
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid white;
            margin-top: 5px;
        }

        #health-fill {
            width: 100%;
            height: 100%;
            background: #ff3333;
        }

        #prompt {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffff00;
            font-weight: bold;
            display: none;
            text-shadow: 2px 2px 4px #000;
        }

        #instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border: 2px solid #333;
            z-index: 10;
        }
    </style>
</head>

<body>

    <div id="crosshair"></div>
    <div id="prompt">[E] OM TE BREACHEN</div>

    <div id="instructions">
        <h1>TACTICAL BREACH</h1>
        <p>Zuiver de kamer van de vijand.</p>
        <p><b>KLIK OM TE STARTEN</b></p>
        <small>WASD: Bewegen | E: Deur Intrappen | Muis: Vuren</small>
    </div>

    <div id="ui">
        <b>OPERATOR STATUS</b>
        <div id="health-bar">
            <div id="health-fill"></div>
        </div>
        <small id="status-text">MISSION: BREACH THE DOOR</small>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- 1. SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x080808, 0.15);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);
        const instr = document.getElementById('instructions');
        instr.addEventListener('click', () => controls.lock());
        controls.addEventListener('lock', () => instr.style.display = 'none');
        controls.addEventListener('unlock', () => instr.style.display = 'block');

        // --- 2. LIGHTING ---
        const ambient = new THREE.AmbientLight(0x050505);
        scene.add(ambient);

        const flashlight = new THREE.SpotLight(0xffffff, 50, 30, Math.PI / 7, 0.5);
        flashlight.castShadow = true;
        camera.add(flashlight);
        flashlight.target.position.z = -1;
        camera.add(flashlight.target);
        scene.add(camera);

        const muzzleFlash = new THREE.PointLight(0xffcc00, 0, 10);
        camera.add(muzzleFlash);
        muzzleFlash.position.set(0.3, -0.2, -0.8);

        // --- 3. ASSETS ---
        // Het Geweer
        const gun = new THREE.Group();
        const gunMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
        const gunBody = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.1, 0.4), gunMat);
        const gunBarrel = new THREE.Mesh(new THREE.CylinderGeometry(0.015, 0.015, 0.4), gunMat);
        gunBarrel.rotation.x = Math.PI / 2; gunBarrel.position.z = -0.3;
        gun.add(gunBody, gunBarrel);
        gun.position.set(0.3, -0.3, -0.5);
        camera.add(gun);

        // De Deur (Cruciaal voor de breach)
        const doorPivot = new THREE.Group();
        doorPivot.position.set(0, 0, -5); // Deur staat in de gang
        scene.add(doorPivot);

        const doorMesh = new THREE.Mesh(
            new THREE.BoxGeometry(2.5, 3.5, 0.1),
            new THREE.MeshStandardMaterial({ color: 0x442211 })
        );
        doorMesh.position.x = 1.25; // Draaipunt aan de zijkant
        doorMesh.castShadow = true;
        doorPivot.add(doorMesh);

        // De Omgeving (De Killhouse)
        const obstacles = [];
        const wallMat = new THREE.MeshStandardMaterial({ color: 0x222222 });

        function createWall(x, z, w, h, ry = 0) {
            const wM = new THREE.Mesh(new THREE.BoxGeometry(w, h, 0.5), wallMat);
            wM.position.set(x, h / 2, z); wM.rotation.y = ry;
            wM.receiveShadow = wM.castShadow = true;
            scene.add(wM);
            obstacles.push(wM);
        }

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x111111 }));
        floor.rotation.x = -Math.PI / 2; floor.receiveShadow = true;
        scene.add(floor);

        // Muren rond de deur
        createWall(-5, -5, 8, 4);
        createWall(5, -5, 8, 4);
        createWall(0, -15, 20, 4); // Achtermuur van de kamer

        // De Vijand (wachtend achter de deur)
        const enemy = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1, 4, 8), new THREE.MeshStandardMaterial({ color: 0x660000 }));
        enemy.position.set(2, 1.2, -10);
        enemy.castShadow = true;
        scene.add(enemy);

        // --- 4. GAME LOGICA ---
        let doorOpen = false;
        let enemyAlive = true;
        let health = 100;
        let isShaking = 0;

        function breach() {
            if (camera.position.distanceTo(doorPivot.position) < 4 && !doorOpen) {
                doorOpen = true;
                isShaking = 20; // Start camera shake
                document.getElementById('status-text').innerText = "STATUS: CONTACT!";
                document.getElementById('status-text').style.color = "red";
            }
        }

        function shoot() {
            muzzleFlash.intensity = 40;
            camera.rotation.x += 0.05;
            setTimeout(() => muzzleFlash.intensity = 0, 50);

            const ray = new THREE.Raycaster();
            ray.setFromCamera({ x: 0, y: 0 }, camera);

            if (enemyAlive) {
                const hit = ray.intersectObject(enemy);
                if (hit.length > 0) {
                    enemyAlive = false;
                    enemy.rotation.z = Math.PI / 2; enemy.position.y = 0.5;
                    document.getElementById('status-text').innerText = "STATUS: ROOM CLEAR";
                    document.getElementById('status-text').style.color = "#00ff00";
                }
            }
        }

        // Input Listeners
        window.addEventListener('keydown', (e) => {
            if (e.code === 'KeyE') breach();
            if (e.code === 'KeyW') keys.w = true;
            if (e.code === 'KeyS') keys.s = true;
            if (e.code === 'KeyA') keys.a = true;
            if (e.code === 'KeyD') keys.d = true;
        });
        window.addEventListener('keyup', (e) => {
            if (e.code === 'KeyW') keys.w = false;
            if (e.code === 'KeyS') keys.s = false;
            if (e.code === 'KeyA') keys.a = false;
            if (e.code === 'KeyD') keys.d = false;
        });
        window.addEventListener('mousedown', (e) => {
            if (controls.isLocked && e.button === 0) shoot();
        });

        const keys = { w: false, s: false, a: false, d: false };
        const vel = new THREE.Vector3();
        let lastTime = performance.now();

        // --- 5. ANIMATE LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - lastTime) / 1000;

            if (controls.isLocked) {
                // Beweging
                vel.x -= vel.x * 10 * delta; vel.z -= vel.z * 10 * delta;
                if (keys.w) vel.z -= 50 * delta; if (keys.s) vel.z += 50 * delta;
                if (keys.a) vel.x -= 50 * delta; if (keys.d) vel.x += 50 * delta;

                controls.moveForward(-vel.z * delta);
                controls.moveRight(-vel.x * delta);

                // Deur Animatie
                if (doorOpen && doorPivot.rotation.y > -Math.PI / 1.5) {
                    doorPivot.rotation.y -= 15 * delta; // Snel openklappen
                }

                // UI Prompt check
                const distToDoor = camera.position.distanceTo(doorPivot.position);
                document.getElementById('prompt').style.display = (distToDoor < 4 && !doorOpen) ? 'block' : 'none';

                // Screen Shake Logic
                if (isShaking > 0) {
                    camera.position.x += (Math.random() - 0.5) * 0.1;
                    camera.position.y += (Math.random() - 0.5) * 0.1;
                    isShaking--;
                }

                // AI Schade
                if (enemyAlive && doorOpen && camera.position.distanceTo(enemy.position) < 10) {
                    health -= 0.2;
                    document.getElementById('health-fill').style.width = health + "%";
                }

                // Recoil herstel
                camera.rotation.x -= camera.rotation.x * 0.1;
            }
            lastTime = time;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>