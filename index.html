<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <title>MLO Tactical: Breach & Clear</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Consolas', monospace;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border: 1px solid #ff0000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        #ui {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #0f0;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border: 1px solid #0f0;
        }

        #prompt {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            text-align: center;
            text-shadow: 2px 2px #000;
            display: none;
        }

        #flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>

<body>

    <div id="flash"></div>
    <div id="crosshair"></div>
    <div id="prompt">
        <span style="font-size: 20px; color: #0f0;">[E] OPENEN</span><br>
        <span style="font-size: 14px; color: #f00;">[SHIFT + E] BREACH</span>
    </div>

    <div id="ui">
        <b>[TACTICAL BREACH SYSTEM]</b><br>
        DOOR STATE: <span id="door-state">SECURE</span><br>
        VELOCITY: <span id="speed">0</span>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);
        document.body.addEventListener('click', () => controls.lock());

        scene.add(new THREE.AmbientLight(0xffffff, 0.3));
        const flashlight = new THREE.SpotLight(0xffffff, 50, 30, Math.PI / 7, 0.4);
        camera.add(flashlight);
        flashlight.target.position.z = -1;
        camera.add(flashlight.target);
        scene.add(camera);

        // --- DEUR LOGICA ---
        const doors = [];
        const loader = new GLTFLoader();

        loader.load('huis.glb', (gltf) => {
            const mlo = gltf.scene;
            scene.add(mlo);
            mlo.traverse(child => {
                if (child.isMesh && child.name.toLowerCase().includes('door')) {
                    const pivot = new THREE.Group();
                    pivot.position.copy(child.position);
                    child.position.set(0.6, 0, 0); // Offset voor scharnier aan zijkant
                    pivot.add(child);

                    const doorData = {
                        pivot: pivot,
                        isOpen: false,
                        targetRot: 0,
                        isBreached: false,
                        lerpSpeed: 0.1 // Normale snelheid
                    };
                    doors.push(doorData);
                    scene.add(pivot);
                }
            });
            camera.position.set(0, 1.6, 5);
        });

        // --- INTERACTIE ---
        const raycaster = new THREE.Raycaster();
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (e.code === 'KeyE') handleDoorInteraction();
        });
        window.addEventListener('keyup', (e) => keys[e.code] = false);

        function handleDoorInteraction() {
            raycaster.setFromCamera({ x: 0, y: 0 }, camera);
            const doorObjects = doors.map(d => d.pivot);
            const intersects = raycaster.intersectObjects(doorObjects, true);

            if (intersects.length > 0 && intersects[0].distance < 3) {
                // Vind de juiste deur in onze array
                const hitPivot = intersects[0].object.parent;
                const doorData = doors.find(d => d.pivot === hitPivot);

                if (doorData) {
                    if (keys['ShiftLeft'] || keys['ShiftRight']) {
                        // BREACH
                        doorData.isOpen = true;
                        doorData.targetRot = -Math.PI / 1.2; // Extra ver open
                        doorData.lerpSpeed = 0.25; // Super snel
                        screenShake();
                        document.getElementById('door-state').innerText = "BREACHED";
                        document.getElementById('door-state').style.color = "red";
                    } else {
                        // NORMALE INTERACTIE
                        doorData.isOpen = !doorData.isOpen;
                        doorData.targetRot = doorData.isOpen ? -Math.PI / 1.7 : 0;
                        doorData.lerpSpeed = 0.08;
                        document.getElementById('door-state').innerText = doorData.isOpen ? "OPEN" : "SECURE";
                        document.getElementById('door-state').style.color = "#0f0";
                    }
                }
            }
        }

        function screenShake() {
            const flash = document.getElementById('flash');
            flash.style.opacity = "0.5";
            setTimeout(() => flash.style.opacity = "0", 100);
            // Camera effect
            camera.position.y += 0.1;
            setTimeout(() => camera.position.y -= 0.1, 50);
        }

        // --- MAIN LOOP ---
        let prevTime = performance.now();
        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if (controls.isLocked) {
                // Deur animaties
                doors.forEach(d => {
                    d.pivot.rotation.y = THREE.MathUtils.lerp(d.pivot.rotation.y, d.targetRot, d.lerpSpeed);
                });

                // UI Prompt
                raycaster.setFromCamera({ x: 0, y: 0 }, camera);
                const doorObjects = doors.map(d => d.pivot);
                const intersects = raycaster.intersectObjects(doorObjects, true);
                document.getElementById('prompt').style.display = (intersects.length > 0 && intersects[0].distance < 3) ? 'block' : 'none';

                // Basic Movement
                const speed = (keys['ShiftLeft'] ? 8 : 4);
                if (keys['KeyW']) controls.moveForward(speed * delta);
                if (keys['KeyS']) controls.moveForward(-speed * delta);
                if (keys['KeyA']) controls.moveRight(-speed * delta);
                if (keys['KeyD']) controls.moveRight(speed * delta);

                document.getElementById('speed').innerText = speed;
            }
            prevTime = time;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>

</html>